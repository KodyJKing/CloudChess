<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='Kody King' content=''>
<style type='text/css'>
	#canvas{
		border: 2px solid gray;
	}
</style>
<title>Chess</title>
<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
<script src='chess.js'></script>
<script>
    var lightColor = 'snow';
    var darkColor = 'gray';
    var lightHighlight = 'orange';
    var darkHighlight = 'darkOrange';

    sheetCellWidth = 333;
    var sheet = {king:0,queen:1,bishop:2,knight:3,rook:4,pawn:5};

    tileWidth = 100;

    var canvas;
    var ctx;
    var piecesImg;
    
    document.addEventListener('mousedown', doClick, false);
    document.addEventListener('contextmenu', doClick, false);

    var theGame;
    var gameHistory = [];
    var undos = [];
    var selected = [];
    var pieceSelected = false;
    var activePiece = null;

    var refreshDelay = 10;
    function getGame(loop){
        $.get('game', function(data){
            if(data){
                theGame = data;
                draw();
            }
            if(loop)
                setTimeout(() => getGame(true), refreshDelay);
        });
    }

    window.onload = function(){
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');
        piecesImg = document.getElementById('pieces');

        //getGame(true);
        reset();
    }

    function draw(){
        drawBoard(theGame.board, selected);
        displayTurn();
    }

    function drawBoard(board, selected){
    	for(var x = 0; x < 8; x++){
    		for(var y = 0; y < 8; y++){
                ctx.fillStyle = (x + y) % 2 == 0 ? lightColor : darkColor;
    			ctx.fillRect(x * tileWidth, y * tileWidth, tileWidth, tileWidth);
    		}
    	}

        for(var highlight of selected)
            drawHighlight(highlight);

        for(var piece of board)
            drawPiece(piece);
    }


    function drawPiece(piece){
        if(piece == null)
            return;
    	var sheetX = sheet[piece.kind] * sheetCellWidth;
    	var sheetY =  piece.color == 'white' ? 0 : sheetCellWidth;
    	ctx.drawImage(piecesImg, sheetX, sheetY, sheetCellWidth, sheetCellWidth, piece.pos.x * tileWidth, piece.pos.y * tileWidth, tileWidth, tileWidth);
    }

    function drawHighlight(move){
        ctx.fillStyle = (move.stop.x + move.stop.y) % 2 == 0 ? lightHighlight : darkHighlight;
        ctx.fillRect(move.stop.x * tileWidth, move.stop.y * tileWidth, tileWidth, tileWidth);
    }

    function capped(str){
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function displayTurn(){
        $('#toMove').text(capped(theGame.turn) + ' ' + gameState(theGame) + '.');
    }

    function doClick(ev){
        if (ev.target.id != 'canvas') {
            return;
        }
        ev.preventDefault();
        var x = Math.floor((ev.pageX - $('#canvas').offset().left) / tileWidth);
        var y = Math.floor((ev.pageY - $('#canvas').offset().top) / tileWidth);
        clickLocation(vec(x,y));
        draw();
    }

    function clickLocation(v){
        if(!pieceSelected){
            activePiece = getPiece(theGame.board, v);
            if(activePiece && activePiece.color == theGame.turn){
                pieceSelected = true;
                selected = getMoves(theGame, activePiece);
                if(selected.length == 0)
                    clearSelection();
            }
        }
        else
            tryMove(v);
    }

    function tryMove(destination){
        var m = move(activePiece.pos, destination);
        if(checkMove(theGame, m)){
            performAndSend(m);
        }
        clearSelection();
    }

    function performAndSend(move){
        if(gameState(theGame) != 'playing')
            return;
        if(!move){
            console.log('No move given!');
            return;
        }
        //$.post('submit', move);
        gameHistory.push(cloneGame(theGame));
        performMove(theGame, move);
        draw();
        undos = [];

    }

    function undo(){
        if(gameHistory.length == 0)
            return;
        undos.push(cloneGame(theGame));
        theGame = gameHistory.pop();
        clearSelection();
        draw();
    }

    function redo(){
        if(undos.length == 0)
            return;
        gameHistory.push(cloneGame(theGame));
        theGame = undos.pop();
        clearSelection();
        draw();
    }

    function reset(){
        if(theGame) gameHistory.push(cloneGame(theGame));
        undos = [];
        theGame = game();
        setup(theGame);
        draw();
    }

    function clearSelection(){
        pieceSelected = false;
        selected = [];
        activePiece = null;
    }

    function sendReset(){
        if(!confirm('Reset the game?'))
            return;
        // $.get('reset', function(response){
        //     if(response)
        //         getGame();
        // });
        reset();
    }

    var DEPTH = 3;
    function aiPlay(){
        if(gameState(theGame) != 'playing')
            return;
        var move;
        var result = alphaBeta(theGame, DEPTH, DEPTH % 2 == 0, {mobility : 0.1, agression : 0.2, defense : 0.8, kingDefense : 18, noise : 0.2, movesPerPosition : 32});
        move = result.move;
        if(checkMove(theGame, move))
            performAndSend(move);
        if($('#autoplay').get(0).checked)
            setTimeout(aiPlay, 100);
    }
</script>
</head>
<body>

<div style='display:none'>
<img id='pieces' src='chessPieces.png'>
</div>

<h2>Chess</h2>

<div id='toMove'></div> <div id='gameState'></div>
<canvas id='canvas' width=800 height=800></canvas> <br>

<!-- <button onclick='performAndSend(firstMove(theGame))'>Quick Move</button>
<button onclick='performAndSend(randomMove(theGame))'>Random Move</button>
<button onclick='performAndSend(greedyMove(theGame))'>Greedy Move</button>
<button onclick='performAndSend(oneDeepMove(theGame))'>One Deep Move</button>
<button onclick='performAndSend(nDeepMove(theGame, 3, false))'>Deep Move</button>
<button onclick='performAndSend(nDeepMove(theGame, 3, false, {mobility : 0.1, agression : 0.2, defense : 0.8, kingDefense : 18, noise : 0.5}))'>Noisy Deep Move</button> <br> -->
<!-- <button onclick='getGame(false)'>Refresh</button> -->
<button onclick='undo()'>Undo</button>
<button onclick='redo()'>Redo</button>
<button onclick='aiPlay()'>Go</button> 
<input type="checkbox" id="autoplay" value="Bike">Autoplay</input><br>
<button onclick='sendReset()' style='color: red'>Reset</button>


</body>
</html>